<#
.SYNOPSIS
   Migrate VM from vcenter to vcenter
.DESCRIPTION
   This PowerCLI script helps with the batch migration of the VMs from one vcenter to another one, deleting the
   NIC from the VM and storage vmotioning them to a shared datastore, unregistering them
   It takes the data from a TXT file. 
#>

$VMList = Get-Content D:\Webs\VMs.txt

Foreach ($VM in $VMList) {

# Network card deletion

Get-NetworkAdapter $VM | where { $_.NetworkName -eq "vlan2831_PRO" } | Remove-NetworkAdapter -Confirm:$false

Get-NetworkAdapter $VM | where { $_.NetworkName -eq "vlan1734_MGMT" } | Remove-NetworkAdapter -Confirm:$false

Get-NetworkAdapter $VM | where { $_.NetworkName -eq "vlan3547_BCK" } | Remove-NetworkAdapter -Confirm:$false

# Storage vmotioning

Move-VM -VM $VM -Destination shdbcnbeh09.shdbcn.jc.ts-ian.net -Datastore shdbcnbed3008_ids_compartido -RunAsync

# vcenter unregister

Remove-VM -VM $VM -DeleteFromDisk:$false -Confirm:$false -RunAsync

}


# Second part of the script creates the NICs in the VMs and moves them to the given datastore cluster

$VMList = Get-Content C:\Users\curgel\Desktop\Lista_VM.txt
$myDatastoreCluster1 = Get-DatastoreCluster -Name 'shdbc2gec01'

Foreach ($VM in $VMList) {

New-NetworkAdapter -VM $VM -Type Vmxnet3 -NetworkName vlan2831_PRO -StartConnected:$true -Confirm:$false

New-NetworkAdapter -VM $VM -Type Vmxnet3 -NetworkName vlan1734_MGMT -StartConnected:$true -Confirm:$false

New-NetworkAdapter -VM $VM -Type Vmxnet3 -NetworkName vlan3547_BCK -StartConnected:$true -Confirm:$false

Move-VM -VM $VM -Datastore $myDatastoreCluster1 -RunAsync

}
